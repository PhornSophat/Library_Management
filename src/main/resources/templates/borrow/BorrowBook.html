<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borrow Book - Library Management</title>
    <link rel="stylesheet" th:href="@{/css/output.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 950px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        padding: 40px;
      }

      .header {
        text-align: center;
        border-bottom: 3px solid #667eea;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 32px;
        font-weight: 700;
      }

      .subtitle {
        color: #666;
        font-size: 14px;
      }

      .form-section {
        background-color: #f9f9f9;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .section-title {
        color: #333;
        margin-bottom: 20px;
        font-size: 16px;
        font-weight: 600;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 14px;
      }

      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
      }

      .info-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-left: 4px solid #667eea;
        border-radius: 5px;
        padding: 15px;
        margin-top: 10px;
        display: none;
      }

      .info-card.show {
        display: block;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 600;
        color: #555;
      }

      .info-value {
        color: #333;
        font-weight: 500;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-active {
        background-color: #d4edda;
        color: #155724;
      }

      .status-warning {
        background-color: #fff3cd;
        color: #856404;
      }

      .status-danger {
        background-color: #f8d7da;
        color: #721c24;
      }

      .validation-box {
        border-radius: 5px;
        padding: 15px;
        margin: 20px 0;
        display: none;
        border-left: 4px solid;
      }

      .validation-box.show {
        display: block;
      }

      .validation-box.success {
        background-color: #d4edda;
        border-color: #28a745;
        color: #155724;
      }

      .validation-box.error {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }

      .buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-check {
        background-color: #667eea;
        color: white;
      }

      .btn-check:hover {
        background-color: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-borrow {
        background-color: #28a745;
        color: white;
      }

      .btn-borrow:hover:not(:disabled) {
        background-color: #218838;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
      }

      .btn-borrow:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
      }

      .borrow-section {
        display: none;
      }

      .borrow-section.show {
        display: block;
      }

      .nav-links {
        margin-top: 30px;
        text-align: center;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .nav-links a {
        color: #667eea;
        text-decoration: none;
        margin: 0 15px;
        font-weight: 600;
        display: inline-block;
      }

      .nav-links a:hover {
        text-decoration: underline;
      }

      .required {
        color: #dc3545;
      }

      .content-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .content-wrapper {
          grid-template-columns: 1fr;
        }
      }

      .alert {
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        border-left: 4px solid;
        display: none;
      }

      .alert.show {
        display: block;
      }

      .alert-info {
        background-color: #e7f3ff;
        border-color: #2196f3;
        color: #0c5aa0;
      }

      .alert-warning {
        background-color: #fff3cd;
        border-color: #ffc107;
        color: #856404;
      }

      .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }

      .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }

      .member-status-box {
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
        display: none;
      }

      .member-status-box.show {
        display: block;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .status-item:last-child {
        border-bottom: none;
      }

      .status-label {
        font-weight: 600;
        color: #333;
      }

      .status-value {
        color: #666;
      }

      .badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-success {
        background-color: #d4edda;
        color: #155724;
      }

      .badge-warning {
        background-color: #fff3cd;
        color: #856404;
      }

      .badge-danger {
        background-color: #f8d7da;
        color: #721c24;
      }

      .book-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
      }

      .book-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .book-card:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
      }

      .book-card.selected {
        border-color: #667eea;
        background-color: #f0f4ff;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
      }

      .book-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .book-details {
        font-size: 12px;
        color: #666;
      }

      .book-available {
        font-weight: 600;
        color: #28a745;
      }

      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-purple-600 to-purple-700 min-h-screen">
    <!-- Include SweetAlert2 for better alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- TOP NAVIGATION -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex justify-between items-center">
          <div class="flex items-center space-x-4">
            <a href="javascript:history.back()" class="text-gray-400 hover:text-purple-600 transition-colors">
              <i class="fa-solid fa-arrow-left text-xl"></i>
            </a>
            <i class="fa-solid fa-book-open text-3xl text-purple-600"></i>
            <div>
              <h1 class="text-2xl font-bold text-gray-900">Borrow Book</h1>
              <p class="text-sm text-gray-500">Manage book borrowing requests</p>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <a th:href="@{/member/home}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-semibold flex items-center gap-2">
              <i class="fa-solid fa-home"></i> Dashboard
            </a>
            <a th:href="@{/member/return}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold flex items-center gap-2">
              <i class="fa-solid fa-book-bookmark"></i> Return Book
            </a>
            <form th:action="@{/logout}" method="post" class="inline">
              <button type="submit" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors flex items-center gap-2">
                <i class="fa-solid fa-sign-out-alt"></i>
                <span>Logout</span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="max-w-7xl mx-auto px-6 py-8">
          <!-- HEADER -->
          <div class="text-center border-b-4 border-purple-600 pb-6 mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2"><i class="fa-solid fa-book"></i> Borrow Book</h1>
            <p class="text-gray-600 text-base">Manage book borrowing for library members</p>
          </div>

          <!-- CONTENT WRAPPER -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- LEFT COLUMN: MEMBER INFO & STATUS -->
            <div>
              <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <div class="text-lg font-bold text-gray-900 mb-4 pb-3 border-b-2 border-purple-600">Your Account Information</div>

                <!-- Current Member Display -->
                <div class="bg-white border-2 border-purple-300 rounded-lg p-4 mb-4">
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Member Name:</span>
                    <span class="text-gray-700" th:text="${member.name}">-</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Member ID:</span>
                    <span class="text-gray-700" th:text="${member.id}">-</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Email:</span>
                    <span class="text-gray-700" th:text="${member.email}">-</span>
                  </div>
                  <div class="flex justify-between py-2">
                    <span class="font-semibold text-gray-800">Current Loans:</span>
                    <span class="text-gray-700" th:text="${loanCount}">0</span>
                  </div>
                  <div class="flex justify-between py-2">
                    <span class="font-semibold text-gray-800">Status:</span>
                    <span class="px-3 py-1 rounded-full text-sm font-semibold"
                          th:classappend="${member.status.toString() == 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}"
                          th:text="${member.status}">Active</span>
                  </div>
                </div>

                <!-- VALIDATION ALERTS -->
                <div class="bg-green-100 border-l-4 border-green-600 p-4 rounded text-green-800 mb-3" th:if="${member.status.toString() == 'Active'}">
                  <strong><i class="fa-solid fa-check"></i> READY TO BORROW</strong>
                  <p class="text-sm mt-1">You can borrow a book</p>
                </div>
                
                <div class="bg-red-100 border-l-4 border-red-600 p-4 rounded text-red-800 mb-3" th:if="${member.status.toString() != 'Active'}">
                  <strong><i class="fa-solid fa-ban"></i> BORROW BLOCKED!</strong>
                  <p class="text-sm mt-1">Your account is suspended. Please contact the library.</p>
                </div>
              </div>
            </div>

            <!-- RIGHT COLUMN: BOOK SELECTION -->
            <div>
              <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <div class="text-lg font-bold text-gray-900 mb-4 pb-3 border-b-2 border-purple-600">Select Book to Borrow</div>

                <!-- Show selected book if bookId parameter is present -->
                <div th:if="${selectedBook != null}" class="bg-white border-2 border-purple-500 rounded-lg p-4 mb-4">
                  <div class="text-base font-bold text-gray-900 mb-3">Selected Book</div>
                  <div class="font-bold text-lg text-gray-900" th:text="${selectedBook.title}">Book Title</div>
                  <div class="text-sm text-gray-600" th:text="${selectedBook.author}">Author</div>
                  <div class="text-sm text-green-600 font-semibold mt-2">
                    <i class="fa-solid fa-check-circle"></i> Available
                  </div>
                </div>

                <!-- Show search and book grid if no book is pre-selected -->
                <div th:if="${selectedBook == null}">
                  <div class="mb-4">
                    <label for="bookSearch" class="block text-sm font-semibold text-gray-700 mb-2">Search/Filter Books</label>
                    <input type="text" id="bookSearch" placeholder="Search by title or author..." onkeyup="filterBooks()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                  </div>

                  <div class="space-y-2 max-h-96 overflow-y-auto mb-4" id="bookGrid">
                    <div th:each="book : ${availableBooks}" 
                         th:if="${book.status.toString() == 'AVAILABLE'}"
                         class="book-card bg-white border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:border-purple-500 transition-all"
                         th:attr="data-book-id=${book.id}, data-book-title=${book.title}, data-book-author=${book.author}"
                         onclick="selectBook(this)">
                      <div class="font-bold text-gray-900" th:text="${book.title}">Book Title</div>
                      <div class="text-sm text-gray-600" th:text="${book.author}">Author</div>
                      <div class="text-sm text-green-600 font-semibold mt-1">
                        <i class="fa-solid fa-check-circle"></i> Available
                      </div>
                    </div>
                  </div>
                </div>

                <form th:action="@{/member/borrow/submit}" method="post" id="borrowForm">
                  <input type="hidden" name="bookId" id="selectedBookId" th:value="${selectedBook != null ? selectedBook.id : ''}" required>
                  <input type="hidden" name="dueDate" id="dueDate" required>

                  <div th:if="${selectedBook == null}" class="bg-white border-2 border-gray-300 rounded-lg p-4 mt-4 hidden" id="selectedBookBox">
                    <div class="text-base font-bold text-gray-900 mb-3 pb-2 border-b-2 border-purple-600">Selected Book</div>
                    <div class="flex justify-between py-2 border-b border-gray-200">
                      <span class="font-semibold text-gray-800">Title:</span>
                      <span class="text-gray-700" id="selectedBookTitle">-</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-200">
                      <span class="font-semibold text-gray-800">Author:</span>
                      <span class="text-gray-700" id="selectedBookAuthor">-</span>
                    </div>
                    <div class="flex justify-between py-2">
                    <span class="font-semibold text-gray-800">Available Copies:</span>
                    <span class="text-gray-700" id="selectedBookCopies">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ACTION BUTTONS & SUMMARY -->
          <div class="bg-gray-50 rounded-lg p-6 border border-gray-200 mb-8">
            <div class="text-lg font-bold text-gray-900 mb-4 pb-3 border-b-2 border-purple-600">Step 3: Select Due Date & Confirm Borrowing</div>

            <!-- DUE DATE PRESET SELECTION -->
            <div class="mb-6 bg-white border-2 border-gray-300 rounded-lg p-4">
              <div class="text-base font-bold text-gray-900 mb-4">Due Date Options</div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <!-- Standard 2 weeks -->
                <button type="button" class="px-4 py-3 border-2 border-purple-300 rounded-lg text-left hover:bg-purple-50 transition-all"
                        onclick="setDueDate('standard')">
                  <div class="font-semibold text-gray-800"><i class="fa-solid fa-calendar"></i> Standard (2 weeks)</div>
                  <div class="text-sm text-gray-600" id="standardDate"></div>
                  <span class="text-xs text-gray-500">Default lending period</span>
                </button>

                <!-- 1 week -->
                <button type="button" class="px-4 py-3 border-2 border-gray-300 rounded-lg text-left hover:bg-gray-50 transition-all"
                        onclick="setDueDate('oneweek')">
                  <div class="font-semibold text-gray-800"><i class="fa-solid fa-calendar-minus"></i> Short (1 week)</div>
                  <div class="text-sm text-gray-600" id="oneWeekDate"></div>
                  <span class="text-xs text-gray-500">Quick return</span>
                </button>

                <!-- Overdue Test (Yesterday) - FOR TESTING -->
                <button type="button" class="px-4 py-3 border-2 border-red-400 bg-red-50 rounded-lg text-left hover:bg-red-100 transition-all"
                        onclick="setDueDate('overdue')">
                  <div class="font-semibold text-red-800"><i class="fa-solid fa-flask-vial"></i> TEST: Overdue (Yesterday)</div>
                  <div class="text-sm text-red-600" id="overdueDate"></div>
                  <span class="text-xs text-red-600 font-semibold">🔬 For overdue detection testing</span>
                </button>

                <!-- 1 month -->
                <button type="button" class="px-4 py-3 border-2 border-gray-300 rounded-lg text-left hover:bg-gray-50 transition-all"
                        onclick="setDueDate('onemonth')">
                  <div class="font-semibold text-gray-800"><i class="fa-solid fa-calendar-plus"></i> Extended (1 month)</div>
                  <div class="text-sm text-gray-600" id="oneMonthDate"></div>
                  <span class="text-xs text-gray-500">Longer reading time</span>
                </button>
              </div>

              <!-- Selected Due Date Display -->
              <div class="bg-purple-50 border-l-4 border-purple-600 p-4 rounded">
                <div class="text-sm font-semibold text-gray-700 mb-1">Selected Due Date</div>
                <div class="text-lg font-bold text-purple-700" id="selectedDueDate">Select an option above</div>
              </div>
            </div>

                    <div class="flex justify-between py-2 border-b border-gray-200">
                      <span class="font-semibold text-gray-800">Due Date:</span>
                      <span class="text-gray-700" id="displayDueDate" th:text="${#temporals.format(#temporals.createNow().plusWeeks(2), 'MMM dd, yyyy')}">-</span>
                    </div>
                  </div>

                  <button type="submit" class="w-full mt-4 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors"
                          th:disabled="${member.status.toString() != 'Active'}">
                    <i class="fa-solid fa-check"></i> Confirm Borrow
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- SUCCESS/ERROR MESSAGES -->
          <div th:if="${successMessage}" class="bg-green-100 border-l-4 border-green-600 p-4 rounded text-green-800 mb-4">
            <strong><i class="fa-solid fa-check-circle"></i> Success!</strong>
            <p class="text-sm mt-1" th:text="${successMessage}"></p>
          </div>
          
          <div th:if="${errorMessage}" class="bg-red-100 border-l-4 border-red-600 p-4 rounded text-red-800 mb-4">
            <strong><i class="fa-solid fa-times-circle"></i> Error!</strong>
            <p class="text-sm mt-1" th:text="${errorMessage}"></p>
          </div>

          <!-- BUSINESS LOGIC REFERENCE -->
          <div class="bg-blue-50 rounded-lg p-6 border border-blue-200 mb-8">
            <div class="text-lg font-bold text-gray-900 mb-4 pb-3 border-b-2 border-blue-600"><i class="fa-solid fa-clipboard-list"></i> Business Rules - Lending Logic</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-white rounded-lg p-4 border-l-4 border-purple-600">
                <h4 class="font-bold text-gray-900 mb-3"><i class="fa-solid fa-check"></i> Successful Borrow</h4>
                <p class="text-sm text-gray-700 leading-relaxed">
                  <strong>1.</strong> Book is available<br />
                  <strong>2.</strong> Member has NO overdue books<br />
                  <strong>3.</strong> Member has fewer than 5 borrowed books<br />
                  &darr;<br />
                  <em>Create borrow record with 14-day lending period</em>
                </p>
              </div>

              <div class="bg-white rounded-lg p-4 border-l-4 border-red-600">
                <h4 class="font-bold text-gray-900 mb-3"><i class="fa-solid fa-times"></i> Blocked Scenarios</h4>
                <p class="text-sm text-gray-700 leading-relaxed">
                  <strong>1.</strong> Book out of stock<br />
                  <strong>2.</strong> Member has OVERDUE books &rarr; <strong>SUSPENDED</strong><br />
                  <strong>3.</strong> Member has UNRETURNED books &rarr; <strong>CANNOT BORROW</strong><br />
                  <strong>4.</strong> Member has 5 borrowed books &rarr; <strong>LIMIT REACHED</strong><br />
                  <br />
                  <em>Return items first</em>
                </p>
              </div>
            </div>
          </div>

          <!-- NAV LINKS -->
          <div class="mt-8 text-center pt-6 border-t border-gray-300">
            <a th:href="@{/member/return}" class="text-purple-600 font-semibold hover:underline mx-4">
              <i class="fa-solid fa-book-bookmark"></i> Return/Overdue Books
            </a>
            <a th:href="@{/member/home}" class="text-purple-600 font-semibold hover:underline mx-4">
              <i class="fa-solid fa-home"></i> Back to Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="max-w-7xl mx-auto px-6 py-8 text-center text-gray-500">
      <p>&copy; 2026 Library Management System. All rights reserved.</p>
    </div>

    <script th:inline="javascript">
      // Initialize due date presets on page load
      function initializeDatePresets() {
        const today = new Date();
        
        // Standard: 2 weeks from today
        const standard = new Date(today);
        standard.setDate(standard.getDate() + 14);
        document.getElementById('standardDate').textContent = formatDate(standard);
        
        // One week from today
        const oneWeek = new Date(today);
        oneWeek.setDate(oneWeek.getDate() + 7);
        document.getElementById('oneWeekDate').textContent = formatDate(oneWeek);
        
        // Overdue Test: Yesterday (for testing)
        const overdue = new Date(today);
        overdue.setDate(overdue.getDate() - 1);
        document.getElementById('overdueDate').textContent = formatDate(overdue) + ' (OVERDUE)';
        
        // One month from today
        const oneMonth = new Date(today);
        oneMonth.setMonth(oneMonth.getMonth() + 1);
        document.getElementById('oneMonthDate').textContent = formatDate(oneMonth);
        
        // Set default to standard
        setDueDate('standard');
      }

      function formatDate(date) {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }

      function formatDateISO(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function setDueDate(preset) {
        const today = new Date();
        let dueDate;
        
        switch(preset) {
          case 'standard':
            dueDate = new Date(today);
            dueDate.setDate(dueDate.getDate() + 14);
            document.getElementById('selectedDueDate').textContent = formatDate(dueDate) + ' (Standard - 2 weeks)';
            break;
          case 'oneweek':
            dueDate = new Date(today);
            dueDate.setDate(dueDate.getDate() + 7);
            document.getElementById('selectedDueDate').textContent = formatDate(dueDate) + ' (Short - 1 week)';
            break;
          case 'overdue':
            dueDate = new Date(today);
            dueDate.setDate(dueDate.getDate() - 1);
            document.getElementById('selectedDueDate').innerHTML = '<span class="text-red-600 font-bold">⚠️ ' + formatDate(dueDate) + ' (OVERDUE TEST)</span>';
            break;
          case 'onemonth':
            dueDate = new Date(today);
            dueDate.setMonth(dueDate.getMonth() + 1);
            document.getElementById('selectedDueDate').textContent = formatDate(dueDate) + ' (Extended - 1 month)';
            break;
        }
        
        // Set hidden input with ISO format date
        document.getElementById('dueDate').value = formatDateISO(dueDate);
        
        // Update display
        document.getElementById('displayDueDate').textContent = formatDate(dueDate);
      }

      // Show SweetAlert2 for error messages
      const errorMessage = /*[[${errorMessage}]]*/ null;
      const successMessage = /*[[${successMessage}]]*/ null;
      
      if (errorMessage) {
        Swal.fire({
          icon: 'error',
          title: 'Cannot Borrow Book',
          html: errorMessage,
          confirmButtonColor: '#667eea',
          backdrop: true,
          allowOutsideClick: false,
          allowEscapeKey: false
        });
      }
      
      if (successMessage) {
        Swal.fire({
          icon: 'success',
          title: 'Book Borrowed Successfully',
          html: successMessage,
          confirmButtonColor: '#28a745',
          timer: 3000,
          timerProgressBar: true
        });
      }

      // Book selection functionality
      function selectBook(element) {
        // Remove previous selection
        document.querySelectorAll('.book-card').forEach(card => {
          card.classList.remove('border-purple-500', 'bg-purple-50');
          card.classList.add('border-gray-300');
        });
        
        // Mark selected
        element.classList.remove('border-gray-300');
        element.classList.add('border-purple-500', 'bg-purple-50');
        
        // Get book data
        const bookId = element.getAttribute('data-book-id');
        const bookTitle = element.getAttribute('data-book-title');
        const bookAuthor = element.getAttribute('data-book-author');
        
        // Update hidden input
        document.getElementById('selectedBookId').value = bookId;
        
        // Show selected book info
        document.getElementById('selectedBookTitle').textContent = bookTitle;
        document.getElementById('selectedBookAuthor').textContent = bookAuthor;
        document.getElementById('selectedBookBox').classList.remove('hidden');
      }
      
      // Search functionality
      function filterBooks() {
        const searchTerm = document.getElementById('bookSearch').value.toLowerCase();
        const bookCards = document.querySelectorAll('.book-card');
        
        bookCards.forEach(card => {
          const title = card.getAttribute('data-book-title').toLowerCase();
          const author = card.getAttribute('data-book-author').toLowerCase();
          
          if (title.includes(searchTerm) || author.includes(searchTerm)) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      }

      // Initialize date presets when page loads
      document.addEventListener('DOMContentLoaded', function() {
        initializeDatePresets();
      });
    </script>
  </body>
</html>
