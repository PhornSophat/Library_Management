<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borrow Book - Library Management</title>
    <link rel="stylesheet" th:href="@{/css/output.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 950px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        padding: 40px;
      }

      .header {
        text-align: center;
        border-bottom: 3px solid #667eea;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 32px;
        font-weight: 700;
      }

      .subtitle {
        color: #666;
        font-size: 14px;
      }

      .form-section {
        background-color: #f9f9f9;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .section-title {
        color: #333;
        margin-bottom: 20px;
        font-size: 16px;
        font-weight: 600;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 14px;
      }

      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
      }

      .info-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-left: 4px solid #667eea;
        border-radius: 5px;
        padding: 15px;
        margin-top: 10px;
        display: none;
      }

      .info-card.show {
        display: block;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 600;
        color: #555;
      }

      .info-value {
        color: #333;
        font-weight: 500;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-active {
        background-color: #d4edda;
        color: #155724;
      }

      .status-warning {
        background-color: #fff3cd;
        color: #856404;
      }

      .status-danger {
        background-color: #f8d7da;
        color: #721c24;
      }

      .validation-box {
        border-radius: 5px;
        padding: 15px;
        margin: 20px 0;
        display: none;
        border-left: 4px solid;
      }

      .validation-box.show {
        display: block;
      }

      .validation-box.success {
        background-color: #d4edda;
        border-color: #28a745;
        color: #155724;
      }

      .validation-box.error {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }

      .buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-check {
        background-color: #667eea;
        color: white;
      }

      .btn-check:hover {
        background-color: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-borrow {
        background-color: #28a745;
        color: white;
      }

      .btn-borrow:hover:not(:disabled) {
        background-color: #218838;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
      }

      .btn-borrow:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
      }

      .borrow-section {
        display: none;
      }

      .borrow-section.show {
        display: block;
      }

      .nav-links {
        margin-top: 30px;
        text-align: center;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .nav-links a {
        color: #667eea;
        text-decoration: none;
        margin: 0 15px;
        font-weight: 600;
        display: inline-block;
      }

      .nav-links a:hover {
        text-decoration: underline;
      }

      .required {
        color: #dc3545;
      }

      .content-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .content-wrapper {
          grid-template-columns: 1fr;
        }
      }

      .alert {
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        border-left: 4px solid;
        display: none;
      }

      .alert.show {
        display: block;
      }

      .alert-info {
        background-color: #e7f3ff;
        border-color: #2196f3;
        color: #0c5aa0;
      }

      .alert-warning {
        background-color: #fff3cd;
        border-color: #ffc107;
        color: #856404;
      }

      .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }

      .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }

      .member-status-box {
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
        display: none;
      }

      .member-status-box.show {
        display: block;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .status-item:last-child {
        border-bottom: none;
      }

      .status-label {
        font-weight: 600;
        color: #333;
      }

      .status-value {
        color: #666;
      }

      .badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-success {
        background-color: #d4edda;
        color: #155724;
      }

      .badge-warning {
        background-color: #fff3cd;
        color: #856404;
      }

      .badge-danger {
        background-color: #f8d7da;
        color: #721c24;
      }

      .book-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
      }

      .book-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .book-card:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
      }

      .book-card.selected {
        border-color: #667eea;
        background-color: #f0f4ff;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
      }

      .book-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .book-details {
        font-size: 12px;
        color: #666;
      }

      .book-available {
        font-weight: 600;
        color: #28a745;
      }

      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-purple-600 to-purple-700 min-h-screen p-5">
    <aside class="fixed top-0 left-0 h-screen w-64 z-50">
      <div th:replace="~{fragments/sidebar :: sidebar}"></div>
    </aside>

    <div class="flex flex-col min-h-screen pl-64">
      <nav class="fixed top-0 right-0 left-64 h-16 bg-white/80 backdrop-blur-md z-40 border-b border-gray-100">
        <div th:replace="~{fragments/navigation :: navigation}"></div>
      </nav>

      <main class="p-10 mt-16 mx-auto w-full max-w-6xl">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <!-- HEADER -->
          <div class="text-center border-b-4 border-purple-600 pb-6 mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">üìö Borrow Book</h1>
            <p class="text-gray-600 text-base">Manage book borrowing for library members</p>
          </div>

          <!-- CONTENT WRAPPER -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- LEFT COLUMN: MEMBER & VALIDATION -->
            <div>
              <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <div class="text-lg font-bold text-gray-900 mb-4 pb-3 border-b-2 border-purple-600">Step 1: Select Member</div>

                <div class="mb-4">
                  <label for="memberId" class="block text-sm font-semibold text-gray-700 mb-2">
                    Choose Member <span class="text-red-600">*</span>
                  </label>
                  <select id="memberId" onchange="selectMember()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent font-base">
                    <option value="">-- Select a member --</option>
                    <option value="M006">Eng Mengheang</option>
                    <option value="M005">La Vireak</option>
                    <option value="M003">Luy Lyhor</option>
                    <option value="M004">Phorn Sophath</option>
                    <option value="M001">Bunarith Soksim</option>
                    <option value="M002">Han Raby</option>
                  </select>
                </div>

                <div class="bg-white border-2 border-gray-300 rounded-lg p-4 mb-4 hidden" id="memberStatusBox">
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Member ID:</span>
                    <span class="text-gray-700" id="memberIdDisplay">-</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Email:</span>
                    <span class="text-gray-700" id="memberEmail">-</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Phone:</span>
                    <span class="text-gray-700" id="memberPhone">-</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Current Status:</span>
                    <span class="text-gray-700" id="memberStatus">-</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Unreturned Books:</span>
                    <span class="text-gray-700" id="unreturnedCount">0</span>
                  </div>
                  <div class="flex justify-between py-2">
                    <span class="font-semibold text-gray-800">Overdue Books:</span>
                    <span class="text-gray-700" id="overdueCount">0</span>
                  </div>
                </div>

                <!-- VALIDATION ALERTS -->
                <div class="bg-red-100 border-l-4 border-red-600 p-4 rounded text-red-800 mb-3 hidden" id="alertBlocked">
                  <strong>‚õîÔ∏è BORROW BLOCKED!</strong>
                  <p id="alertBlockedMsg" class="text-sm mt-1"></p>
                </div>

                <div class="bg-yellow-100 border-l-4 border-yellow-600 p-4 rounded text-yellow-800 mb-3 hidden" id="alertWarning">
                  <strong>‚ö†Ô∏è WARNING!</strong>
                  <p id="alertWarningMsg" class="text-sm mt-1"></p>
                </div>

                <div class="bg-green-100 border-l-4 border-green-600 p-4 rounded text-green-800 mb-3 hidden" id="alertReady">
                  <strong>‚úì READY TO BORROW</strong>
                  <p class="text-sm mt-1">This member can borrow a book</p>
                </div>
              </div>
            </div>

            <!-- RIGHT COLUMN: BOOK SELECTION -->
            <div>
              <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                <div class="text-lg font-bold text-gray-900 mb-4 pb-3 border-b-2 border-purple-600">Step 2: Select Book</div>

                <div class="mb-4">
                  <label for="bookSearch" class="block text-sm font-semibold text-gray-700 mb-2">Search/Filter Books</label>
                  <input type="text" id="bookSearch" placeholder="Search by title or author..." onkeyup="filterBooks()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div class="space-y-2 max-h-96 overflow-y-auto" id="bookGrid">
                  <!-- Books will be rendered dynamically from inventory -->
                </div>

                <div class="bg-white border-2 border-gray-300 rounded-lg p-4 mt-4 hidden" id="selectedBookBox">
                  <div class="text-base font-bold text-gray-900 mb-3 pb-2 border-b-2 border-purple-600">Selected Book</div>
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Title:</span>
                    <span class="text-gray-700" id="selectedBookTitle">-</span>
                  </div>
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="font-semibold text-gray-800">Author:</span>
                    <span class="text-gray-700" id="selectedBookAuthor">-</span>
                  </div>
                  <div class="flex justify-between py-2">
                    <span class="font-semibold text-gray-800">Available Copies:</span>
                    <span class="text-gray-700" id="selectedBookCopies">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ACTION BUTTONS & SUMMARY -->
          <div class="bg-gray-50 rounded-lg p-6 border border-gray-200 mb-8">
            <div class="text-lg font-bold text-gray-900 mb-4 pb-3 border-b-2 border-purple-600">Step 3: Confirm Borrowing</div>

            <div id="borrowSummary" class="bg-white p-4 rounded-lg border-l-4 border-purple-600 mb-4 hidden">
              <h3 class="text-purple-600 font-bold text-base mb-3">Borrow Summary</h3>
              <p class="mb-2"><strong>Member:</strong> <span id="summaryMember">-</span></p>
              <p class="mb-2"><strong>Book:</strong> <span id="summaryBook">-</span></p>
              <p class="mb-2"><strong>Borrow Date:</strong> <span id="summaryBorrowDate">-</span></p>
              <p><strong>Due Date:</strong> <span id="summaryDueDate">-</span></p>
            </div>

            <div class="flex gap-3 justify-end">
              <button type="button" onclick="confirmBorrow()" id="confirmBtn" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors hidden">
                ‚úì Confirm Borrow
              </button>
              <button type="button" onclick="resetForm()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">
                ‚Ü∫ Reset Form
              </button>
              <a th:href="@{/}" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors flex items-center gap-2">
                üè† Back to Home
              </a>
            </div>
          </div>

          <!-- BUSINESS LOGIC REFERENCE -->
          <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
            <div class="text-lg font-bold text-gray-900 mb-4 pb-3 border-b-2 border-blue-600">üìã Business Rules - Lending Logic</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-white rounded-lg p-4 border-l-4 border-purple-600">
                <h4 class="font-bold text-gray-900 mb-3">‚úì Successful Borrow</h4>
                <p class="text-sm text-gray-700 leading-relaxed">
                  <strong>1.</strong> Book is available<br />
                  <strong>2.</strong> Member has NO overdue books<br />
                  <strong>3.</strong> Member has NO unreturned books<br />
                  ‚Üì<br />
                  <em>Create borrow record with 14-day lending period</em>
                </p>
              </div>

              <div class="bg-white rounded-lg p-4 border-l-4 border-red-600">
                <h4 class="font-bold text-gray-900 mb-3">‚ùå Blocked Scenarios</h4>
                <p class="text-sm text-gray-700 leading-relaxed">
                  ‚ë† Book out of stock<br />
                  ‚ë° Member has OVERDUE books ‚Üí <strong>SUSPENDED</strong><br />
                  ‚ë¢ Member has UNRETURNED books ‚Üí <strong>CANNOT BORROW</strong><br />
                  <br />
                  <em>Return items first</em>
                </p>
              </div>
            </div>
          </div>

          <!-- NAV LINKS -->
          <div class="mt-8 text-center pt-6 border-t border-gray-300">
            <a href="ReturnBook.html" class="text-purple-600 font-semibold hover:underline mx-4">üì§ Return/Overdue Books</a>
            <a th:href="@{/}" class="text-purple-600 font-semibold hover:underline mx-4">üè† Back to Home</a>
          </div>
        </div>
      </main>
    </div>

    <script>
      // ============================================
      // MENGHEANG - BORROWING LOGIC (Activity Diagram)
      // ============================================
      // Decision Flow:
      // 1. Is Book Available? ‚Üí NO = Error "Book already borrowed"
      // 2. Member has Overdue Books? ‚Üí YES = Error "Member Suspended"
      // 3. Member reached Borrow Limit? ‚Üí YES = Error "Return old books first"
      // 4. All checks passed ‚Üí Create Borrow Record (14-day period)
      // ============================================

      // Member Database
      // Member Database
      // IMPORTANT: Member names MUST match exactly with ReturnBook.html for cross-page data sync
      // These names are used as display defaults, but actual status is calculated from borrowRecords
      const membersDB = {
        M001: {
          name: "Bunarith Soksim",
          email: "bunarith@example.com",
          phone: "555-0001",
          unreturned: 0,
          overdue: false,
          suspended: false,
        },
        M002: {
          name: "Han Raby",
          email: "hanraby@example.com",
          phone: "555-0002",
          unreturned: 0,
          overdue: false,
          suspended: false,
        },
        M003: {
          name: "Luy Lyhor",
          email: "luylyhor@example.com",
          phone: "555-0003",
          unreturned: 2,
          overdue: false,
          suspended: false,
        },
        M004: {
          name: "Phorn Sophath",
          email: "phornsophath@example.com",
          phone: "555-0004",
          unreturned: 0,
          overdue: false,
          suspended: false,
        },
        M005: {
          name: "La Vireak",
          email: "lavireak@example.com",
          phone: "555-0005",
          unreturned: 0,
          overdue: false,
          suspended: false,
        },
        M006: {
          name: "Eng Mengheang",
          email: "engmengheang@example.com",
          phone: "555-0006",
          unreturned: 0,
          overdue: false,
          suspended: false,
        },
      };

      // Book inventory (loaded from localStorage or external JSON)
      let booksDB = {};

      // Render the book grid from the current `booksDB` object
      function renderBookGrid() {
        const grid = document.getElementById("bookGrid");
        if (!grid) return;
        const items = Object.entries(booksDB || {});
        if (items.length === 0) {
          grid.innerHTML = '<div class="text-center py-8 text-gray-500">No books available</div>';
          return;
        }
        grid.innerHTML = items
          .map(([id, b]) => {
            const availability =
              b.available > 0
                ? `<span class="font-semibold text-green-600">‚úì ${b.available} copies</span>`
                : `<span class="font-semibold text-red-600">‚úó Out of stock</span>`;
            return `
                <div class="book-card bg-white border-2 border-gray-300 rounded-lg p-3 cursor-pointer transition-all hover:border-purple-600 hover:bg-purple-50" data-book-id="${id}" tabindex="0" role="button" aria-pressed="false" onclick="selectBook('${id}')" onkeydown="if(event.key==='Enter'||event.key===' ') selectBook('${id}')">
                  <div class="font-semibold text-gray-900 mb-1">${escapeHtml(b.title)}</div>
                  <div class="text-sm text-gray-700 mb-1">${escapeHtml(b.author)}</div>
                  <div class="text-sm">${availability}</div>
                </div>
              `;
          })
          .join("");
      }

      // Safe escape for simple HTML values
      function escapeHtml(str) {
        if (!str) return "";
        return String(str).replace(/[&<>"']/g, function (s) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[s];
        });
      }

      // Load book inventory from localStorage or external JSON file
      async function loadBooksFromStorage() {
        try {
          // Prefer localStorage if present
          const storedBooks = localStorage.getItem("booksDB");
          if (storedBooks) {
            const parsed = JSON.parse(storedBooks);
            if (typeof parsed === "object" && parsed !== null) {
              booksDB = parsed;
              console.log("Loaded book inventory from localStorage");
              renderBookGrid();
              updateBookCardDisplay();
              return;
            }
          }

          // Try to fetch a static JSON file (served from /static/data/books.json)
          try {
            const res = await fetch("/static/data/books.json");
            if (!res.ok) throw new Error("Not found");
            const json = await res.json();
            booksDB = json;
            saveBooksToStorage();
            console.log("Loaded book inventory from /static/data/books.json");
            renderBookGrid();
            updateBookCardDisplay();
            return;
          } catch (e) {
            // Fallback: try /data/books.json (if mounted differently)
            try {
              const res2 = await fetch("/data/books.json");
              if (res2.ok) {
                booksDB = await res2.json();
                saveBooksToStorage();
                console.log("Loaded book inventory from /data/books.json");
                renderBookGrid();
                updateBookCardDisplay();
                return;
              }
            } catch (e2) {
              console.warn(
                "No external books JSON available, using empty inventory"
              );
            }
          }

          // Nothing found - keep booksDB empty and render
          booksDB = booksDB || {};
          renderBookGrid();
          updateBookCardDisplay();
        } catch (error) {
          console.error("Error loading books from storage or JSON:", error);
        }
      }

      // Save book inventory to localStorage
      function saveBooksToStorage() {
        try {
          localStorage.setItem("booksDB", JSON.stringify(booksDB));
          console.log("Book inventory saved to localStorage");
        } catch (error) {
          console.error("Error saving books to storage:", error);
        }
      }

      // Keep pages in different tabs/windows in sync by listening to storage events
      window.addEventListener("storage", (e) => {
        try {
          if (!e.key) return;
          if (e.key === "booksDB") {
            const parsed = JSON.parse(e.newValue || "{}") || {};
            booksDB = parsed;
            renderBookGrid();
            updateBookCardDisplay();
            console.log("booksDB updated from storage event");
          }

          if (e.key === "borrowRecords") {
            // Refresh member status and UI when borrowRecords change elsewhere
            updateMemberStatusFromRecords();
            if (selectedMemberId) {
              selectMember();
            }
            console.log("borrowRecords updated from storage event");
          }
        } catch (err) {
          console.warn("Error handling storage event:", err);
        }
      });

      // Update member status from actual borrow records
      // This function ensures member status (unreturned count, overdue) is always calculated from
      // real borrowing data rather than relying on hardcoded values
      // Called on page load and after each borrow/return action
      function updateMemberStatusFromRecords() {
        const borrowRecords =
          JSON.parse(localStorage.getItem("borrowRecords")) || [];

        // Step 1: Reset all members to default status
        Object.keys(membersDB).forEach((memberId) => {
          membersDB[memberId].unreturned = 0;
          membersDB[memberId].overdue = false;
        });

        // Step 2: Scan all borrow records and update member status based on actual data
        borrowRecords.forEach((record) => {
          if (membersDB[record.memberId]) {
            // Count unreturned books (BORROWED or OVERDUE status means not yet returned)
            if (record.status === "BORROWED" || record.status === "OVERDUE") {
              membersDB[record.memberId].unreturned++;
            }
            // Mark as overdue if any record has OVERDUE status
            if (record.status === "OVERDUE") {
              membersDB[record.memberId].overdue = true;
            }
          }
        });

        console.log("Member statuses updated from borrow records:", membersDB);
      }

      // Update book card display with current inventory from localStorage
      // This function iterates through all books and refreshes their UI to show current availability
      // Called on page load to ensure display matches actual book inventory
      function updateBookCardDisplay() {
        Object.keys(booksDB).forEach((bookId) => {
          const book = booksDB[bookId];
          const card = document.querySelector(`[data-book-id="${bookId}"]`);
          if (card) {
            const detailsDiv = card.querySelector(".book-details:last-child");
            if (book.available > 0) {
              detailsDiv.innerHTML = `<span class="book-available">‚úì ${book.available} copies</span>`;
            } else {
              detailsDiv.innerHTML = `<span class="book-unavailable">‚úó Out of stock</span>`;
            }
          }
        });
        console.log("Book card display updated with current inventory");
      }

      let selectedMemberId = null;
      let selectedBookId = null;

      function selectMember() {
        const memberId = document.getElementById("memberId").value;
        if (!memberId) {
          document.getElementById("memberStatusBox").classList.remove("show");
          clearValidationAlerts();
          return;
        }

        selectedMemberId = memberId;
        const member = membersDB[memberId];

        // Display member details
        document.getElementById("memberIdDisplay").textContent = memberId;
        document.getElementById("memberEmail").textContent = member.email;
        document.getElementById("memberPhone").textContent = member.phone;
        document.getElementById("unreturnedCount").textContent =
          member.unreturned;
        document.getElementById("overdueCount").textContent = member.overdue
          ? "Yes"
          : "No";

        // Set status badge
        let statusBadge = "";
        if (member.suspended) {
          statusBadge = '<span class="badge badge-danger">‚õîÔ∏è SUSPENDED</span>';
        } else if (member.overdue) {
          statusBadge = '<span class="badge badge-danger">‚õîÔ∏è OVERDUE</span>';
        } else if (member.unreturned > 0) {
          statusBadge =
            '<span class="badge badge-warning">‚ö†Ô∏è UNRETURNED BOOKS</span>';
        } else {
          statusBadge = '<span class="badge badge-success">‚úì ACTIVE</span>';
        }
        document.getElementById("memberStatus").innerHTML = statusBadge;

        // Show validation alerts
        showMemberValidation(memberId, member);

        document.getElementById("memberStatusBox").classList.add("show");
        checkBorrowEligibility();
      }

      function showMemberValidation(memberId, member) {
        clearValidationAlerts();

        // ========================================
        // THREE KEY VALIDATION SCENARIOS
        // ========================================

        if (member.overdue) {
          // SCENARIO 1: Member has OVERDUE books ‚Üí SUSPENDED
          document.getElementById("alertBlocked").classList.add("show");
          document.getElementById("alertBlockedMsg").innerHTML =
            "‚ùå <strong>MEMBER SUSPENDED!</strong><br>" +
            "This member has <strong>OVERDUE BOOKS</strong> and is <strong>SUSPENDED</strong> from borrowing.<br>" +
            "All overdue items must be returned before borrowing new books.<br>" +
            "<br><em>Business Rule: If member already overdue on borrowed book then member suspend on borrowing more book</em>";
        } else if (member.unreturned > 0) {
          // SCENARIO 2: Member has UNRETURNED books ‚Üí CANNOT BORROW
          document.getElementById("alertBlocked").classList.add("show");
          document.getElementById("alertBlockedMsg").innerHTML =
            "‚ùå <strong>CANNOT BORROW!</strong><br>" +
            `This member has <strong>${member.unreturned} UNRETURNED BOOK(S)</strong>.<br>` +
            "All borrowed books must be returned first before borrowing more.<br>" +
            "<br><em>Business Rule: If member already have return the book or not. if not then cannot borrow any more book</em>";
        } else if (member.suspended) {
          // SCENARIO 3: Member is administratively suspended
          document.getElementById("alertBlocked").classList.add("show");
          document.getElementById("alertBlockedMsg").innerHTML =
            "‚ùå <strong>MEMBER SUSPENDED!</strong><br>" +
            "This member has been suspended from borrowing.<br>" +
            "Please contact administration to lift the suspension.";
        } else {
          // All good - member is eligible
          document.getElementById("alertReady").classList.add("show");
        }
      }

      function clearValidationAlerts() {
        document.getElementById("alertBlocked").classList.remove("show");
        document.getElementById("alertWarning").classList.remove("show");
        document.getElementById("alertReady").classList.remove("show");
      }

      function selectBook(bookId) {
        selectedBookId = bookId;

        // Remove previous selection and reset aria-pressed
        document.querySelectorAll(".book-card").forEach((card) => {
          card.classList.remove("selected");
          card.classList.remove("border-purple-600");
          card.classList.remove("bg-purple-50");
          card.classList.add("border-gray-300");
          card.classList.add("bg-white");
          card.setAttribute('aria-pressed', 'false');
        });

        // Select current book
        const selectedCard = document.querySelector(`[data-book-id="${bookId}"]`);
        if (selectedCard) {
          selectedCard.classList.add("selected");
          selectedCard.classList.remove("border-gray-300");
          selectedCard.classList.remove("bg-white");
          selectedCard.classList.add("border-purple-600");
          selectedCard.classList.add("bg-purple-100");
          selectedCard.classList.add("shadow-lg");
          selectedCard.setAttribute('aria-pressed', 'true');
        }

        const book = booksDB[bookId];

        // Display selected book info
        document.getElementById("selectedBookTitle").textContent = book.title;
        document.getElementById("selectedBookAuthor").textContent = book.author;
        document.getElementById("selectedBookCopies").textContent =
          book.available > 0 ? book.available + " copies" : "Out of stock";

        document.getElementById("selectedBookBox").style.display = "block";

        checkBorrowEligibility();
      }

      function filterBooks() {
        const searchTerm = document
          .getElementById("bookSearch")
          .value.toLowerCase();
        const bookCards = document.querySelectorAll(".book-card");

        bookCards.forEach((card) => {
          const title = card
            .querySelector(".book-title")
            .textContent.toLowerCase();
          const author = card
            .querySelector(".book-details")
            .textContent.toLowerCase();

          if (title.includes(searchTerm) || author.includes(searchTerm)) {
            card.style.display = "block";
          } else {
            card.style.display = "none";
          }
        });
      }

      function checkBorrowEligibility() {
        const confirmBtn = document.getElementById("confirmBtn");
        const borrowSummary = document.getElementById("borrowSummary");

        if (!selectedMemberId || !selectedBookId) {
          confirmBtn.style.display = "none";
          borrowSummary.style.display = "none";
          return;
        }

        const member = membersDB[selectedMemberId];
        const book = booksDB[selectedBookId];

        // ========================================
        // LENDING LOGIC DIAGRAM IMPLEMENTATION
        // ========================================

        // STEP 1: Check if Book is Available
        if (book.available <= 0) {
          // Error: Book already borrowed
          borrowSummary.style.display = "none";
          confirmBtn.style.display = "none";
          showAlertError(
            "Book is OUT OF STOCK! No copies available at this time."
          );
          return;
        }

        // STEP 2: Check if Member has Overdue Books
        if (member.overdue) {
          // Error: Member Suspended
          borrowSummary.style.display = "none";
          confirmBtn.style.display = "none";
          showAlertError(
            "‚ùå MEMBER SUSPENDED!<br><br>This member has OVERDUE BOOKS and is suspended from borrowing.<br>All overdue items must be returned first before borrowing new books."
          );
          return;
        }

        // STEP 3: Check if Member has Unreturned Books
        if (member.unreturned > 0) {
          // Error: Reached Borrow Limit
          borrowSummary.style.display = "none";
          confirmBtn.style.display = "none";
          showAlertError(
            `‚ùå UNRETURNED BOOKS!<br><br>This member has ${member.unreturned} unreturned book(s).<br>All borrowed books must be returned first before borrowing more.`
          );
          return;
        }

        // STEP 4: All checks passed - Create Borrow Record
        // Calculate Due Date (14 days)
        const borrowDate = new Date();
        const dueDate = new Date(
          borrowDate.getTime() + 14 * 24 * 60 * 60 * 1000
        );

        // Show Success Summary
        document.getElementById("summaryMember").textContent =
          member.name + ` (${selectedMemberId})`;
        document.getElementById("summaryBook").textContent = book.title;
        document.getElementById("summaryBorrowDate").textContent =
          borrowDate.toLocaleDateString();
        document.getElementById("summaryDueDate").textContent =
          dueDate.toLocaleDateString();

        borrowSummary.style.display = "block";
        confirmBtn.style.display = "block";

        // Clear any previous error alerts
        document.getElementById("alertBlocked").classList.remove("show");
      }

      function showAlertError(message) {
        document.getElementById("alertBlockedMsg").innerHTML = message;
        document.getElementById("alertBlocked").classList.add("show");
        document.getElementById("alertWarning").classList.remove("show");
        document.getElementById("alertReady").classList.remove("show");
      }

      function confirmBorrow() {
        if (!selectedMemberId || !selectedBookId) {
          alert("Please select both member and book");
          return;
        }

        const member = membersDB[selectedMemberId];
        const book = booksDB[selectedBookId];
        const borrowDate = new Date();
        const dueDate = new Date(
          borrowDate.getTime() + 14 * 24 * 60 * 60 * 1000
        );

        // Create comprehensive borrow record
        const borrowRecord = {
          id: "BR" + Date.now(),
          memberId: selectedMemberId,
          bookId: selectedBookId,
          memberName: member.name,
          memberEmail: member.email,
          memberPhone: member.phone,
          bookTitle: book.title,
          bookAuthor: book.author,
          isbn: book.isbn,
          borrowDate: borrowDate.toISOString().split("T")[0],
          borrowDateDisplay: borrowDate.toLocaleDateString(),
          dueDate: dueDate.toISOString().split("T")[0],
          dueDateDisplay: dueDate.toLocaleDateString(),
          returnDate: null,
          status: "BORROWED",
          fineAmount: 0,
        };

        // Save to localStorage
        let borrowRecords =
          JSON.parse(localStorage.getItem("borrowRecords")) || [];
        borrowRecords.push(borrowRecord);
        localStorage.setItem("borrowRecords", JSON.stringify(borrowRecords));

        // Update book availability and save to localStorage
        book.available--;
        saveBooksToStorage();

        // Update member borrowed count
        if (!member.unreturned) member.unreturned = 0;
        member.unreturned++;

        alert(
          `‚úì SUCCESS!\n\n${member.name} has borrowed:\n"${book.title}"\n\nAvailable copies left: ${book.available}\nDue Date: ${borrowRecord.dueDateDisplay}\n\nRecord ID: ${borrowRecord.id}\n\nüìã Go to Return Book page to manage returns`
        );
        resetForm();
      }

      function resetForm() {
        document.getElementById("memberId").value = "";
        document.getElementById("bookSearch").value = "";
        document.getElementById("memberStatusBox").classList.remove("show");
        document.getElementById("selectedBookBox").style.display = "none";
        document.getElementById("borrowSummary").style.display = "none";
        document.getElementById("confirmBtn").style.display = "none";

        document.querySelectorAll(".book-card").forEach((card) => {
          card.style.display = "block";
          card.classList.remove("selected");
          card.setAttribute('aria-pressed', 'false');
        });

        clearValidationAlerts();
        selectedMemberId = null;
        selectedBookId = null;
      }

      // Initialize - Load book inventory from localStorage on page load
      window.addEventListener("DOMContentLoaded", async function () {
        // Step 1: Load book inventory from localStorage or external JSON (cross-page sync)
        await loadBooksFromStorage();

        // Step 2: Recalculate member status from actual borrow records
        updateMemberStatusFromRecords();

        // Step 3: Refresh book card UI to show current available copies
        updateBookCardDisplay();

        console.log("‚úì BorrowBook.html initialized - data synced");
      });
    </script>
  </body>
</html>
